---

- name: "Run Prework for Rolling Upgrade OSA"
  hosts: all
  remote_user: root
  serial: 1
  vars:
    #main_path: "{{ main_path | '/opt/ansible' }}"
    main_path: '{% set main_path = main_path or "/opt/ansible" %}'
  
  tasks:
    - name: Checkout to a specific release
      git: 
        repo: http://github.com/openstack/openstack-ansible
        dest: "{{ main_path }}"
        clone: no
        accept_hostkey: yes
        recursive: yes
        version: "{{ openstack_release }}"
      tags:
        - config

    - name: Run set-pr-upgrade script to modify run-upgrade.sh
      script: scripts/77-set-pre-upgrade "{{ main_path }}/scripts"
      tags:
        - config

    - name: Run modified run-upgrade.sh -- only pre-req plays
      shell: export TERM=xterm; echo 'YES' | I_REALLY_KNOW_WHAT_I_AM_DOING=true ./run-upgrade.sh
      args:
        chdir: "{{ main_path }}/scripts/"
      tags:
        - pre-upgrade
