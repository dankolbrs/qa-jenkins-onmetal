---
- hosts: deploy_node
  name: Install Tempest on BME
  tasks:
    - name: Install tempest on containers
      command: /usr/local/bin/openstack-ansible os-tempest-install.yml
      args:
        chdir: /opt/openstack-ansible/playbooks/

    - name: Copy os-tempest-install.yml file
      command: /bin/cp os-tempest-install.yml os-tempest-localhost-install.yml
      args:
        chdir: /opt/openstack-ansible/playbooks/

    - name: Update hosts in os-tempest-localhost-install.yml
      replace:
        dest: /opt/openstack-ansible/playbooks/os-tempest-localhost-install.yml
        regexp: 'utility_all'
        replace: 'localhost'

    - name: Install tempest on deploy node
      command: /usr/local/bin/openstack-ansible os-tempest-localhost-install.yml
      args:
        chdir: /opt/openstack-ansible/playbooks/

    - name: Get tempest configuration from container
      command: /usr/local/bin/ansible utility_all[0] -i /opt/openstack-ansible/playbooks/inventory -m fetch -a "src=/opt/tempest_untagged/etc/tempest.conf,dest=/opt/tempest_untagged/etc/tempest.conf"
